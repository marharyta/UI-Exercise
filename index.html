<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="description" content="Exercise">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=no">
  <base href="/">
  <title>UI Exercise</title>
  <!-- inject:css -->
  <link rel="stylesheet" href="/dist/css/main.css">
  <!-- endinject -->
</head>
<body ng-app="uiApp">
  <button id="start">Start</button>
  <button id="stop">Stop</button>
  <div ui-view></div>
  <!-- bower:js -->
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/angular-ui-router/release/angular-ui-router.js"></script>
  <!-- endbower -->
  <!-- inject:js -->
  <script src="/dist/scripts/app.js"></script>
  <!-- endinject -->

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.min.js"></script>

  <script type="text/javascript">
  
  //rate 1:10m skaling

  //racing ring
  const distance = 30000;
  const width = 1200;
  const carSize = 50;
  const distanceTillFinish = 2000; //km 
  //const universeWidth = 1200;


  //atmosphere is 500km => 500km = 500 *1000m  => 500 000px
  const h = 30000;
  const w = 1200;
  const rocketHeight = 50;
  const distanceToFly = 2000; //km to fly for the rocker
  const universeWidth = 1200;

  const svg = d3.select("body").append("svg");

  svg 
    .attr("width", 900)
    .attr("height", 500)//500
    .attr("preserveAspectRatio", "xMidYMin "+ "slice")
    .attr("viewBox", " " + 0 + " "+ 29900 + " " + w + " " + h+ " ")
    .attr("viewBox", " " + 0 + " "+ ((h-rocketHeight)- 40) + " " + w + " " + h+ " ");

  //create defs for extra elements

  var defs = svg.append("defs");

  var skyGradient = defs
    .append("linearGradient")
    .attr("id", "skyGradient")
    .attr("x1", "0.5")
    .attr("x2", "0.5")
    .attr("y1", "1")
    .attr("y2", "0.5");

  skyGradient
    .append("stop") 
    .attr("offset", "0%")
    .attr("stop-color", "lightblue");
    
  skyGradient
    .append("stop")
    .attr("offset", "75%")
    .attr("stop-color", "#213B63");

  skyGradient
    .append("stop")
    .attr("offset", "100%")
    .attr("stop-color", "#122036");

  var ozoneLayerGradient = defs
    .append("linearGradient")
    .attr("id", "ozoneLayerGradient")
    .attr("x1", "0.5")
    .attr("x2", "0.5")
    .attr("y1", "1")
    .attr("y2", "0");

  ozoneLayerGradient
    .append("stop") 
    .attr("offset", "0%")
    .attr("stop-color", "rgba(87,199,167, 0.01)"); //rgb(87,199,167) rgb(121,210167)

  ozoneLayerGradient
    .append("stop") 
    .attr("offset", "50%")
    .attr("stop-color", "rgba(87,199,167, 0.9)");
    
  ozoneLayerGradient
    .append("stop")
    .attr("offset", "100%")
    .attr("stop-color", "rgba(87,199,167, 0.01)");

  //end of defs

  const mainGroup = svg.append("g");

  //background
  const backgroundSky = mainGroup
      .append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("height", h)
      .attr("width", w )
      .attr("fill", "url(#skyGradient)");

  //atmosphere layers
  const tropopauze = mainGroup.append("g"); //12 km => 12 * 1000m => 120 00m/100 => 1200px
  const stratopauze = mainGroup.append("g"); //45 km => 45 000m => 4500px
  const mesopauze = mainGroup.append("g"); //85 km => 85 000m => 8500px
  const thermopauze = mainGroup.append("g"); //20 0km > 200 0 00 = 20000px
  const ionosfeer = mainGroup.append("g"); //500km

  const tropopauzeHeight = 1200;
  const stratopauzeHeight = 4500;
  const mesopauzeHeight = 8500;
  const thermopauzeHeight = 20000;
  const ionosfeerHeight = 30000;

  tropopauze
    .attr("id", "tropopauze")
    .attr("transform", "translate(0," + (h-tropopauzeHeight) +")")
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", tropopauzeHeight)
    .attr("width", w)
    .attr("fill", "transparent");


  stratopauze
    .attr("id", "stratopauze")
    .attr("transform", "translate(0," + (h-stratopauzeHeight) +")")
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", stratopauzeHeight-tropopauzeHeight)
    .attr("width", w)
    .attr("fill", "transparent");

  mesopauze
    .attr("id", "mesopauze")
    .attr("transform", "translate(0," + (h-mesopauzeHeight) +")")
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", mesopauzeHeight - stratopauzeHeight)
    .attr("width", w)
    .attr("fill", "transparent");

  thermopauze
    .attr("id", "thermopauze")
    .attr("transform", "translate(0," + (h-thermopauzeHeight) +")")
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", thermopauzeHeight - mesopauzeHeight)
    .attr("width", w )
    .attr("fill", "transparent");

  ionosfeer
    .attr("id", "ionosfeer")
    .attr("transform", "translate(0," + (h-ionosfeerHeight) +")")
    .append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", ionosfeerHeight - thermopauzeHeight)
    .attr("width", w)
    .attr("fill", "transparent");


  //checkpoints

  tropopauze
    .append("text")
    .attr("x",20)
    .attr("y",0)
    .text("Troposphere");

  stratopauze
    .append("text")
    .attr("x",20)
    .attr("y",0)
    .text("Stratosphere");

  mesopauze
    .append("text")
    .attr("x",20)
    .attr("y",0)
    .text("Mesosphere");

  thermopauze
    .append("text")
    .attr("x",20)
    .attr("y",0)
    .text("Thermosphere");

  ionosfeer
    .append("text")
    .attr("x",20)
    .attr("y",0)
    .text("Ionosphere");

  mainGroup
    .append("text")
    .attr("x",20)
    .attr("y", h-1200)
    .text("1200");

  mainGroup
    .append("text")
    .attr("x",20)
    .attr("y", h-4500)
    .text("4500");

  mainGroup
    .append("text")
    .attr("x",20)
    .attr("y", h-3000)
    .text("3000");

  mainGroup
    .append("text")
    .attr("x",20)
    .attr("y", h-2000)
    .text("2000");

  
      //ozone layer
    const ozoneLayer = stratopauze.append("g"); // 20-30km from earth => 20 000m => 2000
    
    ozoneLayer
      .attr("id", "ozoneLayer")
    .attr("transform", "translate(0," + 1500 +")")
      .append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("height", 1000)
      .attr("width", w)
      .attr("fill", "url(#ozoneLayerGradient)");





  //stars

  let dataset = [];
  const starsGroup = mainGroup.append("g");

  function generateStarsIonosphere(num){
    let arr = [];
    for(var i = 0; i <= num; i++){
      arr.push(3);
    }
    return arr;
  }

  function randmizeStarPosition(){
    let w = Math.floor(Math.random() * width ) + 1;
    let h = Math.floor(Math.random() * (ionosfeerHeight - thermopauzeHeight)) + 1;
    return [w, h];
  }

  dataset = generateStarsIonosphere(500);
  let stars = starsGroup.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("cx", function(d, i) {
              return randmizeStarPosition()[0];
          })
            .attr("cy", function(){
              return randmizeStarPosition()[1];
            })
          .attr("r", function(d) {
                  return d;
          })
          //style
          .attr("fill", "white");

  
  //d3.selectAll("circle").attr("class", "star");

  //rocket  

  let rocket;

  function generateSpeedsRandomly(drivers){

  }
  //generate cars from drivers json
  function generateCars(drivers){
      
    for (var i = 0; i < drivers; i++) {
      drawCar(0,0,0,0,10+i*100);
    }
      
  }

  function drawCar(driver, number, color, size, gap){
     rocket = mainGroup
      .append("rect")
      .attr("class", "rocket")
      .attr("x", w/2 - gap)
      .attr("y", h-rocketHeight)
      .attr("width", 20)
      .attr("height", rocketHeight);
  }
  
  generateCars(5);

  /*function followRocket (yOfRocket, yOfViewPOrt, speedOfFlight, hOfFlight, durationOfFlight){

    durationOfFlight = 20000;
    svg 
      .transition()
    .duration(durationOfFlight)
    .attr("viewBox", " " + 0 + " "+ (h-distanceOfFlight-rocketHeight) + " " + w + " " + h + " ");

    d3.selectAll(".rocket")
      .transition()
      .duration(durationOfFlight)
      .attr("y", h - distanceOfFlight);

  }*/

  
  //followRocket (0,0, 200, 10000, 0);

  /*function drawStarsAtYPosition( YPosition){
    dataset = generateStarsIonosphere(500);
    function calculateStarPosition(){
      let width = Math.floor(Math.random() * w) + 1;
      let height = Math.floor(Math.random() * YPosition+40) + YPosition-40;
      return [width, height];
    }

    let stars = starsGroup.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("cx", function(d, i) {
              return calculateStarPosition()[0];
          })
            .attr("cy", function(){
              return calculateStarPosition()[1];
            })
          .attr("r", function(d) {
                  return d;
          })
          //style
          .attr("fill", "white");

  }*/
  
  /*function launchRocket(yPosition, xPosition){
    var yPos = yPosition;
    var start = null;
    var rocketFly;

    function step(timestamp) {
      if (!start) start = timestamp;
      var progress = timestamp - start;
      
      yPos = progress;
      svg.attr("viewBox", " " + 0 + " "+ (distance-yPos-carSize) + " " + width + " " +  distance + " ");
     
      d3.selectAll(".rocket").attr("y", (distance-yPos));
     

      if (yPos < (30000-carSize)) {
        rocketFly = window.requestAnimationFrame(step);
      }

    }

    window.requestAnimationFrame(step);
    document.getElementById("stop").addEventListener("click", function() {
      cancelAnimationFrame(rocketFly);
    });
  }*/


  function startCars(yPosition, xPosition){
    var yPos = yPosition;
    var start = null;
    var rocketFly;

    function step(timestamp) {
      if (!start) start = timestamp;
      var progress = timestamp - start;
      
      yPos = progress;
      svg.attr("viewBox", " " + 0 + " "+ (h-yPos-rocketHeight) + " " + w + " " +  h+ " ");
     
      d3.selectAll(".rocket").attr("y", (h-yPos));
     

      if (yPos < (30000-carSize)) {
        rocketFly = window.requestAnimationFrame(step);
      }

    }

    window.requestAnimationFrame(step);
    document.getElementById("stop").addEventListener("click", function() {
      cancelAnimationFrame(rocketFly);
    });
  }

  document.getElementById("start").addEventListener("click", function() {
      //launchRocket(0, 0);
      startCars(0, 0);
  });

  /*
    function launchRocket(timestamp, yPosition, xPosition){
    function step(timestamp) {
      if (!start) start = timestamp;

      var progress = timestamp - start;

      svg.attr("viewBox", " " + (xPosition- rocketHeight) + " "+ (h-yPosition-rocketHeight) + " " + w + " " + h + " ");
     
      d3.selectAll(".rocket").attr("y", (h-yPosition));
      d3.selectAll(".rocket").attr("x", (h-xPosition));

      if (progress < (30000-rocketHeight)) {
        window.requestAnimationFrame(step);
      } else if (progress >= (30000-rocketHeight)){
        cancelAnimationFrame(step);
      }
    }

    window.requestAnimationFrame(step);
  }


  

  document.getElementById("start").addEventListener("click", function() {
    launchRocket(0, 5000, 200);
  });

  document.getElementById("stop").addEventListener("click", function() {
    cancelAnimationFrame(step);
  });
  */

  
  </script>
</body>
</html>